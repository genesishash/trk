// Generated by IcedCoffeeScript 108.0.9
(function() {
  var cache, _;

  _ = require('wegweg')({
    globals: true
  });

  cache = null;

  module.exports = function(client, key) {
    var script;
    if (!key) {
      key = 'id-map';
    }
    script = "local identity = redis.call(\"ZSCORE\", KEYS[1], ARGV[1])\nif not identity then\n  identity = redis.call(\"ZCARD\", KEYS[1])\n  redis.call(\"ZADD\", KEYS[1], identity, ARGV[1])\nend\nreturn identity";
    return function(id, cb) {
      var eval_sha;
      if (!id) {
        return cb(new Error("`id` required"));
      }
      eval_sha = function() {
        return client.evalsha([cache, 1, key, id], function(e, r) {
          if (e) {
            return cb(e);
          }
          return cb(null, parseInt(r, 10));
        });
      };
      if (!cache) {
        return client.send_command('SCRIPT', ['LOAD', script], function(e, r) {
          if (e) {
            return cb(e);
          }
          cache = r;
          return eval_sha();
        });
      } else {
        return eval_sha();
      }
    };
  };

  if (!module.parent) {
    log(/DEVEL/);
    process.exit(0);
  }

}).call(this);
